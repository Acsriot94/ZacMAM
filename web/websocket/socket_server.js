var crypto=require("crypto");var tls=require("tls");var https=require("https");var http=require("http");var fs=require("fs");var path=require("path");var privateKeyPath=null;var certificatePath=null;var certificateAuthorityPath=null;var isSecure=false;var siteURL=null;var listenPort=0;var web_server=null;var comments=[];var remotes=[];var sessions=[];var sessionBuffered=[];var configPath=path.resolve(__dirname,"../config/config.php");if(!fs.existsSync(configPath)){logError("Cannot locate configuration file. Please run the installer by visiting http://[your url]/install to set up Kollaborate Server.",null);setTimeout(function(){process.exit(1)},3e4)}else{startServer()}function startServer(){var configData=fs.readFileSync(configPath,"utf8");if(!configData){logError("Error: unable to read configuration file.",null);process.exit(1)}var lines=configData.split("\n");for(var i=0;i<lines.length;i++){var line=lines[i];var startIndex=-1;var middleIndex=line.indexOf("=");var endIndex=line.indexOf(";");if((startIndex=line.indexOf("$_websocket_port"))>-1&&middleIndex>-1&&endIndex>-1){middleIndex+=1;var portString=line.substr(middleIndex,endIndex-middleIndex);portString=portString.replace(/[^0-9]/g,"");listenPort=parseInt(portString)}else if((startIndex=line.indexOf("$_ssl_certificate_authority"))>-1&&middleIndex>-1&&endIndex>-1){middleIndex+=1;certificateAuthorityPath=line.substr(middleIndex,endIndex-middleIndex);certificateAuthorityPath=certificateAuthorityPath.replace(/^\s\s*/,"").replace(/\s\s*$/,"").substr(1)}else if((startIndex=line.indexOf("$_ssl_cert"))>-1&&middleIndex>-1&&endIndex>-1){middleIndex+=1;certificatePath=line.substr(middleIndex,endIndex-middleIndex);certificatePath=certificatePath.replace(/^\s\s*/,"").replace(/\s\s*$/,"").substr(1)}else if((startIndex=line.indexOf("$_ssl_private_key"))>-1&&middleIndex>-1&&endIndex>-1){middleIndex+=1;privateKeyPath=line.substr(middleIndex,endIndex-middleIndex);privateKeyPath=privateKeyPath.replace(/^\s\s*/,"").replace(/\s\s*$/,"").substr(1)}else if((startIndex=line.indexOf("$_url"))>-1&&middleIndex>-1&&endIndex>-1){middleIndex+=1;siteURL=line.substr(middleIndex,endIndex-middleIndex);siteURL=siteURL.replace(/^\s\s*/,"").replace(/\s\s*$/,"").substr(1)}}if(privateKeyPath&&certificatePath&&fs.existsSync(privateKeyPath)&&fs.existsSync(certificatePath)){isSecure=true}if(isNaN(listenPort)||listenPort<=0){listenPort=isSecure?443:80}if(isSecure){var privateKey=fs.readFileSync(privateKeyPath).toString();var certificate=fs.readFileSync(certificatePath).toString();var certAuthority=null;if(certificateAuthorityPath&&fs.existsSync(certificateAuthorityPath))certAuthority=fs.readFileSync(certificateAuthorityPath).toString();var options={key:privateKey,cert:certificate};if(certAuthority)options["ca"]=certAuthority;console.log("Starting secure server...");web_server=https.createServer(options);web_server.on("error",function(err){if(err.errno==="EADDRINUSE"){logError("Couldn't start server. A server is already listening on this address and port.",null)}else{logError("Error starting socket server",err)}});web_server.listen(listenPort)}else{console.log("Starting unencrypted server...");web_server=http.createServer();web_server.on("error",function(err){if(err.errno==="EADDRINUSE"){logError("Couldn't start server. A server is already listening on this address and port.",null)}else{logError("A websocket server error occurred",err)}});web_server.listen(listenPort)}web_server.on("listening",function(){console.log("Server is ready.")});var ws=require("websocket.io");var server=ws.attach(web_server);server.on("connection",function(socket){var params=socket.req.url.split("/");if(params.length>2){var type=params[1];var id=params[2].toString();if(type==="commentstream"){if(typeof comments[id]==="undefined"||comments[id]===null)comments[id]=[];if(comments[id].indexOf(socket)===-1)comments[id].push(socket)}else if(type==="remote"){if(typeof remotes[id]==="undefined"||remotes[id]===null)remotes[id]=[];if(remotes[id].indexOf(socket)===-1)remotes[id].push(socket);if(typeof sessionBuffered[id]==="undefined"||sessionBuffered[id]===null)sessionBuffered[id]=[];broadcast("KCONNECT",remotes[id],socket)}else if(type==="session"){if(typeof sessions[id]==="undefined"||sessions[id]===null)sessions[id]=[];if(sessions[id].indexOf(socket)===-1)sessions[id].push(socket);broadcast("KCONNECT",sessions[id],socket)}socket.on("message",function(message){if(type==="commentstream"){broadcast(message,comments[id],socket)}else if(type==="remote"){if(message==="KPING"){try{socket.send("KPONG")}catch(err){}}else{if(message==="KWAIT"){if(sessionBuffered[id].indexOf(socket)!==-1)sessionBuffered[id].splice(sessionBuffered[id].indexOf(socket),1)}else if(message==="KREADY"){if(sessionBuffered[id].indexOf(socket)===-1)sessionBuffered[id].push(socket);if(sessionBuffered[id].length===remotes[id].length){broadcast("KALLREADY",remotes[id],null);return}}broadcast(message,remotes[id],socket)}}else if(type==="session"){broadcast(message,sessions[id],socket)}});socket.on("close",function(){if(type==="commentstream"){removeSocket(socket,id)}else if(type==="remote"){broadcast("KDISCONNECT",remotes[id],socket);removeSocket(socket,id)}else if(type==="session"){broadcast("KDISCONNECT",sessions[id],socket);removeSocket(socket,id)}});socket.on("error",function(err){logError("A socket error occurred",err);removeSocket(socket,id)})}else{if(socket.req.url!=="/ping")logError("Unknown socket URL: "+socket.req.url,null)}})}function removeSocket(socket,id){id=parseInt(id);if(!socket||id<0)return;if(typeof comments[id]!=="undefined"&&comments[id]!==null&&comments[id].indexOf(socket)>-1)comments[id].splice(comments[id].indexOf(socket),1);if(typeof remotes[id]!=="undefined"&&remotes[id]!==null&&remotes[id].indexOf(socket)>-1)remotes[id].splice(remotes[id].indexOf(socket),1);if(typeof sessionBuffered[id]!=="undefined"&&sessionBuffered[id]!==null&&sessionBuffered[id].indexOf(socket)>-1)sessionBuffered[id].splice(sessionBuffered[id].indexOf(socket),1)}function broadcast(msg,clients,excluded_socket){for(i=0;i<clients.length;i++){var obj=clients[i];if(obj!==excluded_socket){try{obj.send(msg)}catch(err){}}}}process.on("uncaughtException",function(err){logError("Uncaught socket server exception",err)});function logError(err_string,err){console.error("Websocket error: "+err_string);if(err)console.error(err.stack);if(!siteURL||siteURL.indexOf("kollaborate.tv")===-1||err&&err.stack.indexOf("ECONNRESET")>-1||err&&err.stack.indexOf("ETIMEDOUT")>-1){return}var data="Socket server error: "+err_string+" <br>Script: socket_server.js"+(err?" <p>StackTrace: "+err.stack:"");var url=require("url");var urlObj=url.parse(siteURL);var domain=urlObj.hostname;var options={host:domain,path:"/ajax/errorlog",method:"POST",port:443,headers:{"Content-type":"application/x-www-form-urlencoded"}};var errorlog_callback=function(response){var str="";response.on("data",function(chunk){str+=chunk});response.on("end",function(){console.log(str)})};var req=https.request(options,errorlog_callback);req.write("data="+encodeURIComponent(JSON.stringify({message:data})));req.end()}